'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _slicedToArray=function(){function c(d,e){var f=[],g=!0,h=!1,j=void 0;try{for(var l,k=d[Symbol.iterator]();!(g=(l=k.next()).done)&&(f.push(l.value),!(e&&f.length===e));g=!0);}catch(m){h=!0,j=m}finally{try{!g&&k['return']&&k['return']()}finally{if(h)throw j}}return f}return function(d,e){if(Array.isArray(d))return d;if(Symbol.iterator in Object(d))return c(d,e);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),_typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(c){return typeof c}:function(c){return c&&'function'==typeof Symbol&&c.constructor===Symbol&&c!==Symbol.prototype?'symbol':typeof c};exports.default=wikiPage;var _util=require('./util'),_infoboxParser=require('infobox-parser'),_infoboxParser2=_interopRequireDefault(_infoboxParser),_hyntax=require('hyntax'),_coordinates=require('./coordinates');function _interopRequireDefault(c){return c&&c.__esModule?c:{default:c}}function _toConsumableArray(c){if(Array.isArray(c)){for(var d=0,e=Array(c.length);d<c.length;d++)e[d]=c[d];return e}return Array.from(c)}var get=function(c,d){for(var e=arguments.length,f=Array(2<e?e-2:0),g=2;g<e;g++)f[g-2]=arguments[g];return void 0===c||void 0===d?c:'function'==typeof d?get.apply(void 0,[d(c)].concat(f)):get.apply(void 0,[c[d]].concat(f))},firstValue=function(c){return'object'===('undefined'==typeof c?'undefined':_typeof(c))?c[Object.keys(c)[0]]:c[0]},getFileName=function(c){if(Array.isArray(c)&&(c=c[0]),!!c){if(-1!==c.indexOf(':')){var d=c.split(':'),e=_slicedToArray(d,2),f=e[1];return f}return c}};function wikiPage(c,d){function e(){return(0,_util.api)(d,{prop:'revisions',rvprop:'content',rvlimit:1,rvparse:'',titles:C.title}).then(function(E){return E.query.pages[C.pageid].revisions[0]['*']})}function f(){return g().then(_util.parseContent)}function g(){return(0,_util.api)(d,{prop:'extracts',explaintext:'',titles:C.title}).then(function(E){return E.query.pages[C.pageid].extract})}function j(){return(0,_util.api)(d,{generator:'images',gimlimit:'max',prop:'imageinfo',iiprop:'url',titles:C.title}).then(function(E){return E.query?Object.keys(E.query.pages).map(function(F){return E.query.pages[F]}):[]})}function n(E,F){return E.content.attributes&&E.content.attributes.some(function(G){return'class'===G.key.content&&-1!==G.value.content.indexOf(F)})}function o(E){return'tag'===E.nodeType}function p(E,F){return E.content.name===F}function q(E,F){if(F(E))return E;if(E.content.children){var G=!0,H=!1,I=void 0;try{for(var K,J=E.content.children[Symbol.iterator]();!(G=(K=J.next()).done);G=!0){var L=K.value,M=q(L,F);if(M)return M}}catch(L){H=!0,I=L}finally{try{!G&&J.return&&J.return()}finally{if(H)throw I}}}return null}function v(E){return(0,_util.api)(d,{prop:'revisions',rvprop:'content',rvsection:0,titles:E||C.title}).then(function(F){return get(F,'query','pages',firstValue,'revisions',0,'*')})}function x(E){return v().then(function(F){var G=(0,_infoboxParser2.default)(F,d.parser).general;return 0===Object.keys(G).length?v('Template:Infobox '+C.title.toLowerCase()).then(function(H){return(0,_infoboxParser2.default)(H||'',d.parser).general}):G}).then(function(F){return E?F.hasOwnProperty(E)?F[E]:void 0:F})}var C=c,D=Object.assign({},C);return Object.assign(D,{raw:C,html:e,rawContent:g,content:f,sections:f,summary:function(){return(0,_util.api)(d,{prop:'extracts',explaintext:'',exintro:'',titles:C.title}).then(function(E){return E.query.pages[C.pageid].extract})},images:function(){return j().then(function(E){return E.map(function(F){return F.imageinfo}).reduce(function(F,G){return[].concat(_toConsumableArray(F),_toConsumableArray(G))},[]).map(function(F){return F.url})})},references:function(){return e().then(function(E){var F=(0,_hyntax.tokenize)(E),G=F.tokens,H=(0,_hyntax.constructTree)(G),I=H.ast;return I}).then(function(E){var F=[],G=q(E,function(R){return o(R)&&n(R,'references')});if(G){var H=!0,I=!1,J=void 0;try{for(var L,K=G.content.children[0].content.children[Symbol.iterator]();!(H=(L=K.next()).done);H=!0){var R=L.value,S=q(R,function(T){return o(T)&&p(T,'cite')});if(S){var M=!0,N=!1,O=void 0;try{for(var Q,T,P=S.content.children[Symbol.iterator]();!(M=(Q=P.next()).done);M=!0)if(T=Q.value,o(T)&&p(T,'a')&&n(T,'external')){var U=T.content.attributes.find(function(V){return'href'===V.key.content});F.push(U.value.content)}}catch(T){N=!0,O=T}finally{try{!M&&P.return&&P.return()}finally{if(N)throw O}}}}}catch(R){I=!0,J=R}finally{try{!H&&K.return&&K.return()}finally{if(I)throw J}}}return F})},links:function(){var E=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!0,F=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,G=(0,_util.pagination)(d,{prop:'links',plnamespace:0,pllimit:F,titles:C.title},function(H){return(H.query.pages[C.pageid].links||[]).map(function(I){return I.title})});return E?(0,_util.aggregatePagination)(G):G},externalLinks:function(){return(0,_util.api)(d,{prop:'extlinks',ellimit:'max',titles:C.title}).then(function(E){return(E.query.pages[C.pageid].extlinks||[]).map(function(F){return F['*']})})},categories:function(){var E=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!0,F=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,G=(0,_util.pagination)(d,{prop:'categories',pllimit:F,titles:C.title},function(H){return(H.query.pages[C.pageid].categories||[]).map(function(I){return I.title})});return E?(0,_util.aggregatePagination)(G):G},coordinates:function(){return(0,_util.api)(d,{prop:'coordinates',titles:C.title}).then(function(E){var F=E.query.pages[C.pageid];return F.coordinates?F.coordinates[0]:x().then(function(G){return(0,_coordinates.parseCoordinates)(G)})})},info:x,backlinks:function(){var E=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!0,F=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,G=(0,_util.pagination)(d,{list:'backlinks',bllimit:F,bltitle:C.title},function(H){return(H.query.backlinks||[]).map(function(I){return I.title})});return E?(0,_util.aggregatePagination)(G):G},rawImages:j,mainImage:function(){return Promise.all([j(),x()]).then(function(E){var F=_slicedToArray(E,2),G=F[0],H=F[1],I=getFileName(H.image||H.bildname||H.imagen||H.Immagine||H.badge||H.logo);if(!I)return v().then(function(K){if(G.length){G.sort(function(M,N){return K.indexOf(N.title)-K.indexOf(M.title)});var L=G[0];return 0<L.imageinfo.length?L.imageinfo[0].url:void 0}});var J=G.find(function(K){var L=K.title,M=getFileName(L);return M.toUpperCase()===I.toUpperCase()||M.replace(/\s/g,'_')===I});return J&&0<J.imageinfo.length?J.imageinfo[0].url:void 0})},langlinks:function(){return(0,_util.api)(d,{prop:'langlinks',lllimit:'max',llprop:'url',titles:C.title}).then(function(E){return E.query.pages[C.pageid].langlinks.map(function(F){return{lang:F.lang,title:F['*'],url:F.url}})})},rawInfo:v,fullInfo:function(){return v().then(function(E){return(0,_infoboxParser2.default)(E,d.parser)})},tables:function(){return(0,_util.api)(d,{prop:'revisions',rvprop:'content',titles:C.title}).then(function(E){return get(E,'query','pages',firstValue,'revisions',0,'*')}).then(function(E){return(0,_infoboxParser2.default)(E,d.parser).tables})},url:function(){return C.canonicalurl}}),D}
//# sourceMappingURL=page.js.map